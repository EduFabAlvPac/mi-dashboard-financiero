<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Financiero Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #5d5dff;
            --secondary-color: #6a6aff;
            --background-light: #f4f6f8;
            --card-background: #ffffff;
            --text-dark: #333333;
            --text-light: #666666;
            --income-color: #4CAF50;
            --expense-color: #FF7043;
            --debt-color: #ff4d4d;
            --border-color: #e0e0e0;
            --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --border-radius: 12px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--background-light); color: var(--text-dark); padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: var(--card-background); border-radius: 24px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15); overflow: hidden; padding: 40px; }
        .header { text-align: center; margin-bottom: 40px; }
        .header h1 { font-size: 2.8rem; color: var(--primary-color); margin-bottom: 10px; }
        .header p { font-size: 1.2rem; color: var(--text-light); min-height: 22px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 25px; margin-bottom: 30px; }
        .stat-card { background: var(--card-background); padding: 25px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); transition: transform 0.3s ease, box-shadow 0.3s ease; border-left: 5px solid; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }
        .stat-card.income { border-color: var(--income-color); }
        .stat-card.expenses { border-color: var(--expense-color); }
        .stat-card.balance { border-color: var(--primary-color); }
        .stat-card.budget { border-color: #f39c12; }
        .stat-label { font-size: 0.9rem; font-weight: 600; text-transform: uppercase; color: var(--text-light); margin-bottom: 8px; }
        .stat-value { font-size: 2.2rem; font-weight: 700; color: var(--text-dark); }
        .main-content-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px; margin-bottom: 10px; }
        .panel { background: var(--card-background); border-radius: var(--border-radius); padding: 30px; box-shadow: var(--box-shadow); margin-bottom: 30px; }
        .panel h3 { color: var(--text-dark); margin-bottom: 20px; font-size: 1.5rem; border-bottom: 2px solid var(--border-color); padding-bottom: 10px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-dark); }
        .form-group input, .form-group select { width: 100%; padding: 12px 15px; border: 1px solid var(--border-color); background: var(--background-light); border-radius: 8px; font-size: 1rem; color: var(--text-dark); }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(93, 93, 255, 0.1); }
        .btn { background: var(--primary-color); color: white; border: none; padding: 12px 25px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; width: 100%; }
        .btn:hover { background: var(--secondary-color); transform: translateY(-2px); box-shadow: 0 8px 20px rgba(93, 93, 255, 0.3); }
        .transaction-type-buttons { display: flex; gap: 10px; }
        .transaction-type-buttons .btn { flex: 1; background: var(--background-light); color: var(--text-light); border: 1px solid var(--border-color); }
        .transaction-type-buttons .btn.active.income { background: var(--income-color); color: white; border-color: var(--income-color); }
        .transaction-type-buttons .btn.active.expense { background: var(--expense-color); color: white; border-color: var(--expense-color); }
        .categories-container, .subcategories-container { display: flex; flex-wrap: wrap; gap: 8px; }
        .category-btn, .subcategory-btn { padding: 8px 15px; border-radius: 20px; border: 1px solid var(--border-color); background: var(--background-light); color: var(--text-light); cursor: pointer; transition: all 0.2s ease; font-size: 0.9rem; }
        .category-btn.selected, .subcategory-btn.selected { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        .transaction-list, .account-list { max-height: 300px; overflow-y: auto; margin-top: 20px; list-style: none; }
        .transaction-item, .account-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; margin-bottom: 10px; background: var(--background-light); border-radius: 10px; border-left: 4px solid; }
        .transaction-item.income { border-left-color: var(--income-color); }
        .transaction-item.expense { border-left-color: var(--expense-color); }
        .account-item { border-left-color: var(--primary-color); }
        .transaction-info h4, .account-name { margin: 0; color: var(--text-dark); font-size: 1rem; font-weight: 600; }
        .transaction-info p { margin: 5px 0 0 0; color: var(--text-light); font-size: 0.85rem; }
        .transaction-amount, .account-balance { font-weight: 700; font-size: 1.1rem; }
        .amount-income { color: var(--income-color); }
        .amount-expense { color: var(--expense-color); }
        .amount-debt { color: var(--debt-color); }
        .delete-btn { background: none; border: none; color: var(--expense-color); cursor: pointer; font-size: 1.2rem; opacity: 0.7; transition: opacity 0.2s ease; margin-left: 10px; }
        .delete-btn:hover { opacity: 1; }
        .chart-container { width: 100%; height: 400px; }
        .quick-actions-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 10px; }
        .quick-action-btn { background: var(--primary-color); color: white; padding: 20px; border-radius: 12px; text-align: center; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-decoration: none; }
        .quick-action-btn:hover { transform: translateY(-3px); background: var(--secondary-color); box-shadow: 0 10px 25px rgba(93, 93, 255, 0.3); }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .offline-mode { background: #ffecb3; padding: 10px; border-radius: 5px; margin-bottom: 20px; text-align: center; }
        
        /* Estilos para el Modal del Reporte */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); max-width: 500px; width: 90%; position: relative; }
        .modal-close { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light); }
        .report-section { margin-bottom: 20px; }
        .report-section h4 { color: var(--primary-color); border-bottom: 1px solid var(--border-color); padding-bottom: 5px; margin-bottom: 10px; }
        .report-item { display: flex; justify-content: space-between; padding: 5px 0; }
    </style>
</head>
<body>
    <div class="container">
        </div>

    <div id="reportModal" class="modal-overlay">
        <div class="modal-content">
            <button id="closeReportModal" class="modal-close">&times;</button>
            <h3>Reporte Mensual</h3>
            <div id="reportContent"></div>
        </div>
    </div>
    
<script>
// URL de tu Apps Script
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzEwZzFZkDpv55Gv3_FDByx03WTwheGTq_zXF9sysjp1Q2q9M8515r59qMgFK8di8nl/exec';

// Variables globales
let financialData = null;
let isLoading = false;
let currentTransactionType = 'gasto';
let monthlyChart = null;
let monthlyBudget = 0; // NUEVO: Variable para el presupuesto

const categories = {
    gasto: {
        'Alimentación': ['Supermercado', 'Restaurantes', 'Comida rápida'],
        'Transporte': ['Gasolina', 'Transporte público', 'Mantenimiento'],
        'Entretenimiento': ['Cine', 'Streaming', 'Eventos'],
        'Personales': ['Ropa', 'Cuidado personal', 'Gimnasio'],
        'Salud': ['Medicamentos', 'Consultas médicas', 'Seguro'],
        'Hogar': ['Arriendo', 'Servicios', 'Mantenimiento'],
        'Educación': ['Cursos', 'Libros', 'Matrículas'],
        'Créditos': ['Pago Tarjeta', 'Préstamos'],
        'Otros': ['Regalos', 'Donaciones']
    },
    ingreso: {
        'Salario': ['Nómina', 'Freelance', 'Bonos'],
        'Inversiones': ['Dividendos', 'Intereses'],
        'Regalos': ['Cumpleaños', 'Navidad', 'Otros'],
        'Otros ingresos': ['Ventas', 'Reembolsos', 'Otros']
    }
};

async function sendDataToSheet(action, data, shouldReload = true) {
    if (shouldReload) { isLoading = true; showLoadingState(); }
    try {
        const response = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: action, data: data }), headers: { 'Content-Type': 'text/plain;charset=utf-8' } });
        if (!response.ok) throw new Error('La respuesta del servidor no fue exitosa.');
        const result = await response.json();
        if (result.status === 'success' && shouldReload) {
            console.log(`Acción '${action}' completada. Recargando datos...`);
            setTimeout(() => { loadFinancialData(); }, 1000);
        } else if (result.status !== 'success') {
            throw new Error(result.message || 'El servidor reportó un error.');
        }
    } catch (error) {
        console.error('Error al enviar datos:', error);
        alert(`Hubo un error al guardar o refrescar los datos: ${error.message}`);
        if (shouldReload) { isLoading = false; hideLoadingState(); }
    }
}

async function loadFinancialData() {
    isLoading = true;
    console.log('Cargando datos financieros...');
    try {
        showLoadingState();
        showLoadingIndicatorsInLists();
        const response = await fetch(APPS_SCRIPT_URL);
        if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
        const data = await response.json();
        if (data.status === 'success') {
            financialData = data;
            console.log('Datos cargados exitosamente:', data);
            updateInterface(data);
            hideOfflineMode();
            initializeChart(data.transactions);
        } else {
            throw new Error(data.message || 'Error en los datos recibidos');
        }
    } catch (error) {
        console.error('Error cargando datos:', error);
        showOfflineMode();
        loadFallbackData();
    } finally {
        isLoading = false;
        hideLoadingState();
    }
}

function updateInterface(data) {
    const totals = calculateTotals(data.accounts, data.transactions);
    updateBalanceCards(totals);
    updateAccountsList(data.accounts, data.transactions);
    updateObligationsList(data.obligations, data.transactions);
    updateRecentTransactions(data.transactions);
    updateAccountDropdowns(data.accounts, data.obligations);
}

// MEJORA: El cálculo del presupuesto ahora considera el presupuesto guardado.
function calculateTotals(accounts = [], transactions = []) {
    let totalBalance = 0;
    let monthlyIncome = 0;
    let monthlyExpenses = 0;
    
    accounts.forEach(account => {
        let currentAccountBalance = parseFloat(account.initialBalance) || 0;
        transactions.forEach(t => {
            if (t.account === account.name) {
                if (t.type === 'ingreso') currentAccountBalance += parseFloat(t.amount) || 0;
                else if (t.type === 'gasto') currentAccountBalance -= parseFloat(t.amount) || 0;
            }
        });
        totalBalance += currentAccountBalance;
    });

    const currentDate = new Date();
    const currentMonth = currentDate.getMonth();
    const currentYear = currentDate.getFullYear();
    transactions.forEach(t => {
        if (t.category === 'Créditos' && t.subcategory === 'Pago Tarjeta') return;
        const transactionDate = new Date(t.date);
        const adjustedDate = new Date(transactionDate.valueOf() + transactionDate.getTimezoneOffset() * 60 * 1000);
        if (adjustedDate.getMonth() === currentMonth && adjustedDate.getFullYear() === currentYear) {
            const amount = parseFloat(t.amount) || 0;
            if (t.type === 'ingreso') monthlyIncome += amount;
            else if (t.type === 'gasto') monthlyExpenses += amount;
        }
    });

    // Si hay un presupuesto establecido, se usa para el cálculo. Si no, se usa el ingreso del mes.
    const remaining = monthlyBudget > 0 ? monthlyBudget - monthlyExpenses : monthlyIncome - monthlyExpenses;
    return { totalBalance, monthlyIncome, monthlyExpenses, remainingBudget: remaining };
}

// MEJORA: Lógica de validación dinámica para campos requeridos.
function toggleRequiredFields(isPayment) {
    document.getElementById('description').required = !isPayment;
    document.getElementById('account').required = !isPayment;
    document.getElementById('transferFrom').required = isPayment;
    document.getElementById('transferTo').required = isPayment;
}

function selectCategory(category) {
    document.querySelectorAll('.category-btn.selected').forEach(btn => btn.classList.remove('selected'));
    const selectedBtn = Array.from(document.querySelectorAll('.category-btn')).find(btn => btn.textContent === category);
    if (selectedBtn) selectedBtn.classList.add('selected');

    const subcategoryGroup = document.getElementById('subcategoryGroup');
    const subcategoryContainer = document.getElementById('subcategoryContainer');
    const subcats = categories[currentTransactionType][category];
    
    if (subcats && subcats.length > 0) {
        subcategoryGroup.style.display = 'block';
        subcategoryContainer.innerHTML = '';
        subcats.forEach(subcat => {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'subcategory-btn';
            button.textContent = subcat;
            button.addEventListener('click', () => {
                document.querySelectorAll('.subcategory-btn.selected').forEach(btn => btn.classList.remove('selected'));
                button.classList.add('selected');
                const isPayment = category === 'Créditos' && subcat === 'Pago Tarjeta';
                document.getElementById('standard-form-fields').style.display = isPayment ? 'none' : 'block';
                document.getElementById('transfer-form-fields').style.display = isPayment ? 'block' : 'none';
                toggleRequiredFields(isPayment);
            });
            subcategoryContainer.appendChild(button);
        });
    } else {
        subcategoryGroup.style.display = 'none';
        subcategoryContainer.innerHTML = '';
        document.getElementById('standard-form-fields').style.display = 'block';
        document.getElementById('transfer-form-fields').style.display = 'none';
        toggleRequiredFields(false);
    }
}

async function addTransaction() {
    const date = document.getElementById('date').value;
    const amount = parseFloat(document.getElementById('amount').value);

    if (document.getElementById('transfer-form-fields').style.display === 'block') {
        const transferFrom = document.getElementById('transferFrom').value;
        const transferTo = document.getElementById('transferTo').value;
        if (!amount || amount <= 0 || !transferFrom || !transferTo || !date) { alert('Para un pago, selecciona las cuentas de origen y destino, y un monto válido.'); return; }
        
        isLoading = true;
        showLoadingState();

        const expenseTransaction = { type: 'gasto', amount: amount, description: `Pago a ${transferTo}`, category: 'Créditos', subcategory: 'Pago Tarjeta', account: transferFrom, date: date, EsTransferencia: 'sí' };
        await sendDataToSheet('addTransaction', expenseTransaction, false);

        const incomeTransaction = { type: 'ingreso', amount: amount, description: `Abono desde ${transferFrom}`, category: 'Créditos', subcategory: 'Pago Tarjeta', account: transferTo, date: date, EsTransferencia: 'sí' };
        await sendDataToSheet('addTransaction', incomeTransaction, true);
    } else {
        const description = document.getElementById('description').value;
        const account = document.getElementById('account').value;
        if (!amount || amount <= 0 || !description || !account || !date) { alert('Por favor, completa todos los campos.'); return; }
        const category = document.querySelector('.category-btn.selected')?.textContent || '';
        if (!category) { alert('Por favor selecciona una categoría'); return; }
        const subcategory = document.querySelector('.subcategory-btn.selected')?.textContent || '';
        const transaction = { type: currentTransactionType, amount, description, category, subcategory, account, date, EsTransferencia: '' };
        sendDataToSheet('addTransaction', transaction);
    }
    document.getElementById('transactionForm').reset();
    document.getElementById('date').valueAsDate = new Date();
    document.getElementById('subcategoryGroup').style.display = 'none';
    document.querySelectorAll('.selected').forEach(btn => btn.classList.remove('selected'));
    document.getElementById('standard-form-fields').style.display = 'block';
    document.getElementById('transfer-form-fields').style.display = 'none';
    toggleRequiredFields(false);
}

// --- Resto de las funciones (sin cambios en su lógica interna) ---
function addAccount() { const name = document.getElementById('newAccountName').value; const initialBalance = parseFloat(document.getElementById('initialBalance').value) || 0; if (!name) { alert('Por favor ingresa un nombre para la cuenta'); return; } const account = { name, initialBalance, date: new Date().toISOString().split('T')[0] }; sendDataToSheet('addAccount', account); document.getElementById('accountForm').reset(); }
function addObligation() { const name = document.getElementById('obligationName').value; const type = document.getElementById('obligationType').value; const limit = parseFloat(document.getElementById('creditLimit').value); const paymentDay = parseInt(document.getElementById('paymentDay').value); if (!name || !limit || limit <= 0 || !paymentDay || paymentDay < 1 || paymentDay > 31) { alert('Por favor, completa todos los campos con valores válidos.'); return; } const obligation = { id: 'obl_' + Date.now(), name, type, limit, paymentDay }; sendDataToSheet('addObligation', obligation); document.getElementById('obligationForm').reset(); }
function updateBalanceCards(totals) { document.getElementById('totalIncome').textContent = formatCurrency(totals.monthlyIncome); document.getElementById('totalExpenses').textContent = formatCurrency(totals.monthlyExpenses); document.getElementById('currentBalance').textContent = formatCurrency(totals.totalBalance); document.getElementById('remainingBudget').textContent = formatCurrency(totals.remainingBudget); }
function updateAccountsList(accounts = [], transactions = []) { const container = document.getElementById('accountList'); container.innerHTML = ''; if (accounts.length === 0) { container.innerHTML = '<li class="account-item">No hay cuentas registradas.</li>'; return; } accounts.forEach(account => { let currentBalance = parseFloat(account.initialBalance) || 0; transactions.forEach(t => { if (t.account === account.name) { if (t.type === 'ingreso') currentBalance += parseFloat(t.amount) || 0; else if (t.type === 'gasto') currentBalance -= parseFloat(t.amount) || 0; } }); const item = document.createElement('li'); item.className = 'account-item'; item.innerHTML = `<div class="account-info"><h4 class="account-name">${escapeHtml(account.name)}</h4><p>Saldo actual</p></div><div class="account-balance ${currentBalance < 0 ? 'amount-debt' : ''}">${formatCurrency(currentBalance)}</div>`; container.appendChild(item); }); }
function updateObligationsList(obligations = [], transactions = []) { const container = document.getElementById('obligationList'); container.innerHTML = ''; if (obligations.length === 0) { container.innerHTML = '<li class="account-item">No hay obligaciones registradas.</li>'; return; } obligations.forEach(obligation => { let debt = 0; transactions.forEach(t => { if (t.account === obligation.name) { if (t.type === 'gasto') debt += parseFloat(t.amount) || 0; else if (t.type === 'ingreso') debt -= parseFloat(t.amount) || 0; } }); const item = document.createElement('li'); item.className = 'account-item'; item.innerHTML = `<div class="account-info"><h4 class="account-name">${escapeHtml(obligation.name)}</h4><p>Límite: ${formatCurrency(obligation.limit)}</p></div><div class="account-balance"><span class="amount-debt" style="font-size: 1rem; display: block;">Deuda: ${formatCurrency(debt)}</span></div>`; container.appendChild(item); }); }
function updateRecentTransactions(transactions = []) { const container = document.getElementById('transactionList'); container.innerHTML = ''; if (transactions.length === 0) { container.innerHTML = '<li class="transaction-item">No hay transacciones registradas.</li>'; return; } const sorted = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date)); sorted.slice(0, 10).forEach(transaction => { const amount = parseFloat(transaction.amount) || 0; const item = document.createElement('li'); item.className = `transaction-item ${transaction.type === 'ingreso' ? 'income' : 'expense'}`; item.innerHTML = `<div class="transaction-info"><h4>${escapeHtml(transaction.description)}</h4><p>${escapeHtml(transaction.category)} ${transaction.subcategory ? '- ' + escapeHtml(transaction.subcategory) : ''} | ${escapeHtml(transaction.account)}</p><small>${formatDate(transaction.date)}</small></div><div class="transaction-amount ${transaction.type === 'ingreso' ? 'amount-income' : 'amount-expense'}">${transaction.type === 'ingreso' ? '+' : '-'}${formatCurrency(Math.abs(amount))}</div>`; container.appendChild(item); }); }
function initializeChart(transactions) { const ctx = document.getElementById('monthlyChart').getContext('2d'); if (!ctx) return; if (monthlyChart) monthlyChart.destroy(); const months = []; const incomeData = []; const expensesData = []; const currentDate = new Date(); for (let i = 5; i >= 0; i--) { const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1); months.push(date.toLocaleDateString('es-CO', { month: 'short', year: 'numeric' })); let monthlyIncome = 0, monthlyExpenses = 0; if (transactions && Array.isArray(transactions)) { transactions.forEach(t => { if (t.category === 'Créditos' && t.subcategory === 'Pago Tarjeta') return; const tDate = new Date(t.date); if (tDate.getMonth() === date.getMonth() && tDate.getFullYear() === date.getFullYear()) { const amount = parseFloat(t.amount) || 0; if (t.type === 'ingreso') monthlyIncome += amount; else if (t.type === 'gasto') monthlyExpenses += amount; } }); } incomeData.push(monthlyIncome); expensesData.push(monthlyExpenses); } monthlyChart = new Chart(ctx, { type: 'line', data: { labels: months, datasets: [ { label: 'Ingresos', data: incomeData, borderColor: '#4CAF50', backgroundColor: 'rgba(76, 175, 80, 0.1)', tension: 0.3, fill: true }, { label: 'Gastos', data: expensesData, borderColor: '#FF7043', backgroundColor: 'rgba(255, 112, 67, 0.1)', tension: 0.3, fill: true } ] }, options: { responsive: true, plugins: { title: { display: true, text: 'Comportamiento Financiero últimos 6 meses' } }, scales: { y: { beginAtZero: true, ticks: { callback: (value) => '$' + value.toLocaleString('es-CO') } } } } }); }
function updateAccountDropdowns(accounts, obligations) { const accountDropdown = document.getElementById('account'); const transferFrom = document.getElementById('transferFrom'); const transferTo = document.getElementById('transferTo'); [accountDropdown, transferFrom, transferTo].forEach(dd => dd.innerHTML = '<option value="">Seleccionar...</option>'); if (accounts) accounts.forEach(acc => { [accountDropdown, transferFrom].forEach(dd => dd.add(new Option(acc.name, acc.name))); }); if (obligations) obligations.forEach(obl => { [accountDropdown, transferTo].forEach(dd => dd.add(new Option(obl.name, obl.name))); }); }
function formatCurrency(amount) { return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(parseFloat(amount) || 0); }
function formatDate(dateString) { try { const date = new Date(dateString); const userTimezoneOffset = date.getTimezoneOffset() * 60000; return new Date(date.getTime() + userTimezoneOffset).toLocaleDateString('es-CO', {day:'2-digit', month: '2-digit', year:'numeric'}); } catch { return dateString; } }
function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text || ''; return div.innerHTML; }
function showLoadingState() { document.getElementById('loadingOverlay').style.display = 'flex'; }
function hideLoadingState() { document.getElementById('loadingOverlay').style.display = 'none'; }
function showOfflineMode() { document.getElementById('offlineMode').style.display = 'block'; }
function hideOfflineMode() { document.getElementById('offlineMode').style.display = 'none'; }
function retryLoadData() { loadFinancialData(); }
function loadFallbackData() { const fallbackData = { accounts: [{name: "Bancolombia (Offline)", initialBalance: 5000000, date: "2025-09-15"}], obligations: [{id: "obl_1", name: "Visa (Offline)", type: "Tarjeta de Crédito", limit: 10000000, paymentDay: 15}], transactions: [{type: "ingreso", amount: 4000000, description: "Nómina (Offline)", category: "Salario", account: "Bancolombia (Offline)", date: "2025-09-15"}], status: "offline" }; updateInterface(fallbackData); initializeChart(fallbackData.transactions); }
function initializeCategories() { const container = document.getElementById('categoryContainer'); container.innerHTML = ''; Object.keys(categories[currentTransactionType]).forEach(category => { const button = document.createElement('button'); button.type = 'button'; button.className = 'category-btn'; button.textContent = category; button.addEventListener('click', () => selectCategory(category)); container.appendChild(button); }); }
function setupTransactionTypeButtons() { document.querySelectorAll('.transaction-type-buttons .btn').forEach(button => { button.addEventListener('click', function() { document.querySelectorAll('.transaction-type-buttons .btn').forEach(btn => btn.classList.remove('active')); this.classList.add('active'); currentTransactionType = this.dataset.type; initializeCategories(); document.getElementById('subcategoryGroup').style.display = 'none'; document.getElementById('standard-form-fields').style.display = 'block'; document.getElementById('transfer-form-fields').style.display = 'none'; toggleRequiredFields(false); }); }); }
function setupFormHandlers() { document.getElementById('transactionForm').addEventListener('submit', e => { e.preventDefault(); addTransaction(); }); document.getElementById('accountForm').addEventListener('submit', e => { e.preventDefault(); addAccount(); }); document.getElementById('obligationForm').addEventListener('submit', e => { e.preventDefault(); addObligation(); }); }

// --- NUEVAS FUNCIONES ---

function setMonthlyBudget() {
    const currentBudget = localStorage.getItem('monthlyBudget') || 0;
    const budgetInput = prompt('Ingresa tu presupuesto mensual:', currentBudget);
    if (budgetInput !== null) {
        const newBudget = parseFloat(budgetInput);
        if (!isNaN(newBudget) && newBudget >= 0) {
            monthlyBudget = newBudget;
            localStorage.setItem('monthlyBudget', newBudget);
            updateInterface(financialData); // Actualiza la UI inmediatamente
            alert(`Presupuesto mensual establecido en: ${formatCurrency(newBudget)}`);
        } else {
            alert('Por favor, ingresa un número válido.');
        }
    }
}

function generateReport() {
    if (!financialData) { alert('Aún no hay datos para generar un reporte.'); return; }
    const { monthlyIncome, monthlyExpenses } = calculateTotals(financialData.accounts, financialData.transactions);
    
    const categoryTotals = {};
    const currentDate = new Date();
    const currentMonth = currentDate.getMonth();
    const currentYear = currentDate.getFullYear();

    financialData.transactions.forEach(t => {
        const transactionDate = new Date(t.date);
        const adjustedDate = new Date(transactionDate.valueOf() + transactionDate.getTimezoneOffset() * 60 * 1000);
        if (t.type === 'gasto' && adjustedDate.getMonth() === currentMonth && adjustedDate.getFullYear() === currentYear) {
            const amount = parseFloat(t.amount) || 0;
            categoryTotals[t.category] = (categoryTotals[t.category] || 0) + amount;
        }
    });

    let categoryHtml = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1]).map(([category, total]) => `
        <div class="report-item">
            <span>${escapeHtml(category)}</span>
            <span>${formatCurrency(total)}</span>
        </div>
    `).join('');

    if (!categoryHtml) categoryHtml = '<p>No hay gastos este mes.</p>';

    const reportContent = document.getElementById('reportContent');
    reportContent.innerHTML = `
        <div class="report-section">
            <h4>Resumen del Mes</h4>
            <div class="report-item"><span>Ingresos Totales:</span><span class="amount-income">${formatCurrency(monthlyIncome)}</span></div>
            <div class="report-item"><span>Gastos Totales:</span><span class="amount-expense">${formatCurrency(monthlyExpenses)}</span></div>
        </div>
        <div class="report-section">
            <h4>Gastos por Categoría</h4>
            ${categoryHtml}
        </div>
    `;

    document.getElementById('reportModal').style.display = 'flex';
}

function arrayToCsv(data) {
    if (data.length === 0) return '';
    const headers = Object.keys(data[0]);
    const csvRows = [
        headers.join(','),
        ...data.map(row => 
            headers.map(header => {
                let value = row[header] === null || row[header] === undefined ? '' : row[header];
                return `"${String(value).replace(/"/g, '""')}"`; // Escapa comillas
            }).join(',')
        )
    ];
    return csvRows.join('\n');
}

function downloadCsv(csvContent, fileName) {
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', fileName);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}

function exportData() {
    if (!financialData) { alert('No hay datos para exportar.'); return; }
    if (confirm('¿Quieres descargar los datos como archivos CSV?')) {
        downloadCsv(arrayToCsv(financialData.accounts), 'cuentas.csv');
        downloadCsv(arrayToCsv(financialData.obligations), 'obligaciones.csv');
        downloadCsv(arrayToCsv(financialData.transactions), 'transacciones.csv');
    }
}

function clearAllData() { if (confirm('¿Seguro que quieres eliminar todos los datos? Esta acción es experimental y no borra los datos de Google Sheets.')) { alert('Función de limpiar datos en desarrollo.'); } }

function initializeApp() {
    console.log('Inicializando aplicación...');
    // Cargar presupuesto guardado al iniciar
    monthlyBudget = parseFloat(localStorage.getItem('monthlyBudget')) || 0;

    initializeCategories();
    setupTransactionTypeButtons();
    setupFormHandlers();
    
    // Listeners para el modal
    document.getElementById('reportModal').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) {
            e.currentTarget.style.display = 'none';
        }
    });
    document.getElementById('closeReportModal').addEventListener('click', () => {
        document.getElementById('reportModal').style.display = 'none';
    });

    document.getElementById('date').valueAsDate = new Date();
    loadFinancialData();
    console.log('Aplicación inicializada.');
}

document.addEventListener('DOMContentLoaded', initializeApp);
</script>
</body>
</html>