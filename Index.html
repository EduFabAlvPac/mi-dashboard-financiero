<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Financiero Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #5d5dff;
            --secondary-color: #6a6aff;
            --background-light: #f4f6f8;
            --card-background: #ffffff;
            --text-dark: #333333;
            --text-light: #666666;
            --income-color: #4CAF50;
            --expense-color: #FF7043;
            --debt-color: #ff4d4d;
            --border-color: #e0e0e0;
            --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --border-radius: 12px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--background-light); color: var(--text-dark); padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: var(--card-background); border-radius: 24px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15); overflow: hidden; padding: 40px; }
        .header { text-align: center; margin-bottom: 40px; }
        .header h1 { font-size: 2.8rem; color: var(--primary-color); margin-bottom: 10px; }
        .header p { font-size: 1.2rem; color: var(--text-light); min-height: 22px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 25px; margin-bottom: 30px; }
        .stat-card { background: var(--card-background); padding: 25px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); transition: transform 0.3s ease, box-shadow 0.3s ease; border-left: 5px solid; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }
        .stat-card.income { border-color: var(--income-color); }
        .stat-card.expenses { border-color: var(--expense-color); }
        .stat-card.balance { border-color: var(--primary-color); }
        .stat-card.budget { border-color: #f39c12; }
        .stat-label { font-size: 0.9rem; font-weight: 600; text-transform: uppercase; color: var(--text-light); margin-bottom: 8px; }
        .stat-value { font-size: 2.2rem; font-weight: 700; color: var(--text-dark); }
        .main-content-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px; margin-bottom: 10px; }
        .panel { background: var(--card-background); border-radius: var(--border-radius); padding: 30px; box-shadow: var(--box-shadow); margin-bottom: 30px; }
        .panel h3 { color: var(--text-dark); margin-bottom: 20px; font-size: 1.5rem; border-bottom: 2px solid var(--border-color); padding-bottom: 10px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-dark); }
        .form-group input, .form-group select { width: 100%; padding: 12px 15px; border: 1px solid var(--border-color); background: var(--background-light); border-radius: 8px; font-size: 1rem; color: var(--text-dark); }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(93, 93, 255, 0.1); }
        .btn { background: var(--primary-color); color: white; border: none; padding: 12px 25px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; width: 100%; }
        .btn:hover { background: var(--secondary-color); transform: translateY(-2px); box-shadow: 0 8px 20px rgba(93, 93, 255, 0.3); }
        .transaction-type-buttons { display: flex; gap: 10px; }
        .transaction-type-buttons .btn { flex: 1; background: var(--background-light); color: var(--text-light); border: 1px solid var(--border-color); }
        .transaction-type-buttons .btn.active.income { background: var(--income-color); color: white; border-color: var(--income-color); }
        .transaction-type-buttons .btn.active.expense { background: var(--expense-color); color: white; border-color: var(--expense-color); }
        .categories-container, .subcategories-container { display: flex; flex-wrap: wrap; gap: 8px; }
        .category-btn, .subcategory-btn { padding: 8px 15px; border-radius: 20px; border: 1px solid var(--border-color); background: var(--background-light); color: var(--text-light); cursor: pointer; transition: all 0.2s ease; font-size: 0.9rem; }
        .category-btn.selected, .subcategory-btn.selected { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        .transaction-list, .account-list { max-height: 300px; overflow-y: auto; margin-top: 20px; list-style: none; }
        .transaction-item, .account-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; margin-bottom: 10px; background: var(--background-light); border-radius: 10px; border-left: 4px solid; }
        .transaction-item.income { border-left-color: var(--income-color); }
        .transaction-item.expense { border-left-color: var(--expense-color); }
        .account-item { border-left-color: var(--primary-color); }
        .transaction-info h4, .account-name { margin: 0; color: var(--text-dark); font-size: 1rem; font-weight: 600; }
        .transaction-info p { margin: 5px 0 0 0; color: var(--text-light); font-size: 0.85rem; }
        .transaction-amount, .account-balance { font-weight: 700; font-size: 1.1rem; }
        .amount-income { color: var(--income-color); }
        .amount-expense { color: var(--expense-color); }
        .amount-debt { color: var(--debt-color); }
        .delete-btn { background: none; border: none; color: var(--expense-color); cursor: pointer; font-size: 1.2rem; opacity: 0.7; transition: opacity 0.2s ease; margin-left: 10px; }
        .delete-btn:hover { opacity: 1; }
        .chart-container { width: 100%; height: 400px; }
        .quick-actions-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 10px; }
        .quick-action-btn { background: var(--primary-color); color: white; padding: 20px; border-radius: 12px; text-align: center; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-decoration: none; }
        .quick-action-btn:hover { transform: translateY(-3px); background: var(--secondary-color); box-shadow: 0 10px 25px rgba(93, 93, 255, 0.3); }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .offline-mode { background: #ffecb3; padding: 10px; border-radius: 5px; margin-bottom: 20px; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <div class="loading-overlay" id="loadingOverlay" style="display: none;">
            <div style="text-align: center;">
                <div style="font-size: 24px; margin-bottom: 10px;">Cargando datos...</div>
                <div style="width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #5d5dff; border-radius: 50%; margin: 0 auto; animation: spin 1s linear infinite;"></div>
            </div>
        </div>
        
        <div class="offline-mode" id="offlineMode" style="display: none;">
            <p>Estás en modo offline. Los datos pueden no estar actualizados.</p>
            <button class="btn" onclick="retryLoadData()" style="background: var(--expense-color); width: auto; margin-top: 10px;">Reintentar conexión</button>
        </div>
        
        <div class="header">
            <h1>Finanzas Personales Pro</h1>
            <p id="app-subtitle">Control financiero intuitivo y elegante</p>
        </div>
        <div class="stats-grid">
            <div class="stat-card income"><div class="stat-label">Ingresos del Mes</div><div class="stat-value" id="totalIncome">$0</div></div>
            <div class="stat-card expenses"><div class="stat-label">Gastos del Mes</div><div class="stat-value" id="totalExpenses">$0</div></div>
            <div class="stat-card balance"><div class="stat-label">Balance Total</div><div class="stat-value" id="currentBalance">$0</div></div>
            <div class="stat-card budget"><div class="stat-label">Presupuesto Restante</div><div class="stat-value" id="remainingBudget">$0</div></div>
        </div>
        <div class="main-content-grid">
            <div class="panel">
                <h3>Registrar Transacción</h3>
                <form id="transactionForm">
                    <div class="form-group"><label>Tipo</label><div class="transaction-type-buttons"><button type="button" class="btn active expense" data-type="gasto">Gasto</button><button type="button" class="btn income" data-type="ingreso">Ingreso</button></div></div>
                    <div class="form-group"><label>Categoría</label><div id="categoryContainer" class="categories-container"></div></div>
                    <div class="form-group" id="subcategoryGroup" style="display: none;"><label>Subcategoría</label><div id="subcategoryContainer" class="subcategories-container"></div></div>
                    <div class="form-group"><label for="amount">Monto</label><input type="number" id="amount" step="0.01" placeholder="0.00" required></div>
                    
                    <div id="standard-form-fields">
                        <div class="form-group"><label for="description">Descripción</label><input type="text" id="description" placeholder="Ej: Supermercado" required></div>
                        <div class="form-group"><label for="account">Cuenta / Tarjeta de Crédito</label><select id="account" required><option value="">Seleccionar...</option></select></div>
                    </div>

                    <div id="transfer-form-fields" style="display: none;">
                        <div class="form-group"><label for="transferFrom">Pagar Desde la Cuenta</label><select id="transferFrom"></select></div>
                        <div class="form-group"><label for="transferTo">Pagar a la Tarjeta</label><select id="transferTo"></select></div>
                    </div>

                    <div class="form-group"><label for="date">Fecha</label><input type="date" id="date" required></div>
                    <button type="submit" class="btn">Agregar Transacción</button>
                </form>
            </div>
            <div class="panel">
                <h3>Mis Cuentas</h3>
                <form id="accountForm">
                    <div class="form-group"><label for="newAccountName">Nombre de la Cuenta</label><input type="text" id="newAccountName" placeholder="Ej: Cuenta de Ahorros" required></div>
                    <div class="form-group"><label for="initialBalance">Saldo Inicial ($)</label><input type="number" id="initialBalance" step="0.01" placeholder="0.00"></div>
                    <button type="submit" class="btn" style="background: var(--income-color);">Agregar Cuenta</button>
                </form>
                <ul id="accountList" class="account-list"></ul>
            </div>
            <div class="panel">
                <h3>Obligaciones Crediticias</h3>
                <form id="obligationForm">
                    <div class="form-group"><label for="obligationName">Nombre de la Obligación</label><input type="text" id="obligationName" placeholder="Ej: Tarjeta Visa" required></div>
                    <div class="form-group"><label for="obligationType">Tipo</label><select id="obligationType" required><option value="Tarjeta de Crédito">Tarjeta de Crédito</option><option value="Crédito de Consumo">Crédito de Consumo</option></select></div>
                    <div class="form-group"><label for="creditLimit">Monto / Límite de Crédito ($)</label><input type="number" id="creditLimit" step="0.01" placeholder="5000000" required></div>
                    <div class="form-group"><label for="paymentDay">Día Límite de Pago (del mes)</label><input type="number" id="paymentDay" min="1" max="31" placeholder="15" required></div>
                    <button type="submit" class="btn">Agregar Obligación</button>
                </form>
                <ul id="obligationList" class="account-list"></ul>
            </div>
        </div>
        <div class="panel"><h3>Comportamiento Financiero</h3><div class="chart-container"><canvas id="monthlyChart"></canvas></div></div>
        <div class="panel"><h3>Transacciones Recientes</h3><div class="transaction-list" id="transactionList"></div></div>
        <div class="quick-actions-grid">
            <div class="quick-action-btn" onclick="setMonthlyBudget()">Establecer Presupuesto</div>
            <div class="quick-action-btn" onclick="generateReport()">Generar Reporte</div>
            <div class="quick-action-btn" onclick="exportData()">Exportar Datos</div>
            <div class="quick-action-btn" onclick="clearAllData()">Limpiar Datos</div>
        </div>
    </div>
<script>
// URL de tu Apps Script
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzEwZzFZkDpv55Gv3_FDByx03WTwheGTq_zXF9sysjp1Q2q9M8515r59qMgFK8di8nl/exec';

// Variables globales
let financialData = null;
let isLoading = false;
let currentTransactionType = 'gasto';
let monthlyChart = null;

const categories = {
    gasto: {
        'Alimentación': ['Supermercado', 'Restaurantes', 'Comida rápida'],
        'Transporte': ['Gasolina', 'Transporte público', 'Mantenimiento'],
        'Entretenimiento': ['Cine', 'Streaming', 'Eventos'],
        'Personales': ['Ropa', 'Cuidado personal', 'Gimnasio'],
        'Salud': ['Medicamentos', 'Consultas médicas', 'Seguro'],
        'Hogar': ['Arriendo', 'Servicios', 'Mantenimiento'],
        'Educación': ['Cursos', 'Libros', 'Matrículas'],
        'Créditos': ['Pago Tarjeta', 'Préstamos'],
        'Otros': ['Regalos', 'Donaciones']
    },
    ingreso: {
        'Salario': ['Nómina', 'Freelance', 'Bonos'],
        'Inversiones': ['Dividendos', 'Intereses'],
        'Regalos': ['Cumpleaños', 'Navidad', 'Otros'],
        'Otros ingresos': ['Ventas', 'Reembolsos', 'Otros']
    }
};

// MEJORA: La función ahora puede controlar si debe recargar la UI o no.
async function sendDataToSheet(action, data, shouldReload = true) {
    // No mostramos el spinner para envíos intermedios.
    if (shouldReload) {
        isLoading = true;
        showLoadingState();
    }
    try {
        const response = await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action: action, data: data }),
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        });

        if (!response.ok) throw new Error('La respuesta del servidor no fue exitosa.');
        const result = await response.json();

        if (result.status === 'success' && shouldReload) {
            console.log(`Acción '${action}' completada. Recargando datos...`);
            // Dejamos un pequeño margen para que Google Sheets procese el guardado.
            setTimeout(() => { loadFinancialData(); }, 1000); // Aumentado a 1 segundo para mayor seguridad.
        } else if (result.status !== 'success') {
            throw new Error(result.message || 'El servidor reportó un error.');
        }

    } catch (error) {
        console.error('Error al enviar datos:', error);
        alert(`Hubo un error al guardar o refrescar los datos: ${error.message}`);
        if (shouldReload) {
            isLoading = false;
            hideLoadingState();
        }
    }
}

async function loadFinancialData() {
    isLoading = true;
    console.log('Cargando datos financieros...');
    try {
        showLoadingState();
        showLoadingIndicatorsInLists();
        
        const response = await fetch(APPS_SCRIPT_URL);
        if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
        
        const data = await response.json();
        if (data.status === 'success') {
            financialData = data;
            console.log('Datos cargados exitosamente:', data);
            updateInterface(data);
            hideOfflineMode();
            initializeChart(data.transactions);
        } else {
            throw new Error(data.message || 'Error en los datos recibidos');
        }
    } catch (error) {
        console.error('Error cargando datos:', error);
        showOfflineMode();
        loadFallbackData();
    } finally {
        isLoading = false;
        hideLoadingState();
    }
}

function showLoadingIndicatorsInLists() {
    const loadingMessage = '<li class="account-item" style="justify-content: center;">Cargando...</li>';
    document.getElementById('accountList').innerHTML = loadingMessage;
    document.getElementById('obligationList').innerHTML = loadingMessage;
    document.getElementById('transactionList').innerHTML = '<div class="transaction-item" style="justify-content: center;">Cargando...</div>';
}

function updateInterface(data) {
    const totals = calculateTotals(data.accounts, data.transactions);
    updateBalanceCards(totals);
    updateAccountsList(data.accounts, data.transactions);
    updateObligationsList(data.obligations, data.transactions);
    updateRecentTransactions(data.transactions);
    updateAccountDropdowns(data.accounts, data.obligations);
}

function calculateTotals(accounts = [], transactions = []) {
    let totalBalance = 0;
    let monthlyIncome = 0;
    let monthlyExpenses = 0;
    
    accounts.forEach(account => {
        let currentAccountBalance = parseFloat(account.initialBalance) || 0;
        transactions.forEach(transaction => {
            if (transaction.account === account.name) {
                if (transaction.type === 'ingreso') currentAccountBalance += parseFloat(transaction.amount) || 0;
                else if (transaction.type === 'gasto') currentAccountBalance -= parseFloat(transaction.amount) || 0;
            }
        });
        totalBalance += currentAccountBalance;
    });

    const currentDate = new Date();
    const currentMonth = currentDate.getMonth();
    const currentYear = currentDate.getFullYear();
    transactions.forEach(transaction => {
        if (transaction.category === 'Créditos' && transaction.subcategory === 'Pago Tarjeta') return;

        const transactionDate = new Date(transaction.date);
        const adjustedDate = new Date(transactionDate.valueOf() + transactionDate.getTimezoneOffset() * 60 * 1000);
        if (adjustedDate.getMonth() === currentMonth && adjustedDate.getFullYear() === currentYear) {
            const amount = parseFloat(transaction.amount) || 0;
            if (transaction.type === 'ingreso') monthlyIncome += amount;
            else if (transaction.type === 'gasto') monthlyExpenses += amount;
        }
    });

    return { totalBalance, monthlyIncome, monthlyExpenses, remainingBudget: monthlyIncome - monthlyExpenses };
}

function updateAccountsList(accounts = [], transactions = []) {
    const container = document.getElementById('accountList');
    container.innerHTML = '';
    if (accounts.length === 0) { container.innerHTML = '<li class="account-item">No hay cuentas registradas.</li>'; return; }
    accounts.forEach(account => {
        let currentBalance = parseFloat(account.initialBalance) || 0;
        transactions.forEach(t => {
            if (t.account === account.name) {
                if (t.type === 'ingreso') currentBalance += parseFloat(t.amount) || 0;
                else if (t.type === 'gasto') currentBalance -= parseFloat(t.amount) || 0;
            }
        });
        const item = document.createElement('li');
        item.className = 'account-item';
        item.innerHTML = `<div class="account-info"><h4 class="account-name">${escapeHtml(account.name)}</h4><p>Saldo actual</p></div><div class="account-balance ${currentBalance < 0 ? 'amount-debt' : ''}">${formatCurrency(currentBalance)}</div>`;
        container.appendChild(item);
    });
}

function updateObligationsList(obligations = [], transactions = []) {
    const container = document.getElementById('obligationList');
    container.innerHTML = '';
    if (obligations.length === 0) { container.innerHTML = '<li class="account-item">No hay obligaciones registradas.</li>'; return; }
    obligations.forEach(obligation => {
        let debt = 0;
        transactions.forEach(t => {
            if (t.account === obligation.name) {
                if (t.type === 'gasto') debt += parseFloat(t.amount) || 0;
                else if (t.type === 'ingreso') debt -= parseFloat(t.amount) || 0;
            }
        });
        const item = document.createElement('li');
        item.className = 'account-item';
        item.innerHTML = `<div class="account-info"><h4 class="account-name">${escapeHtml(obligation.name)}</h4><p>Límite: ${formatCurrency(obligation.limit)}</p></div><div class="account-balance"><span class="amount-debt" style="font-size: 1rem; display: block;">Deuda: ${formatCurrency(debt)}</span></div>`;
        container.appendChild(item);
    });
}

function updateRecentTransactions(transactions = []) {
    const container = document.getElementById('transactionList');
    container.innerHTML = '';
    if (transactions.length === 0) { container.innerHTML = '<li class="transaction-item">No hay transacciones registradas.</li>'; return; }
    const sorted = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
    sorted.slice(0, 10).forEach(transaction => {
        const amount = parseFloat(transaction.amount) || 0;
        const item = document.createElement('li');
        item.className = `transaction-item ${transaction.type === 'ingreso' ? 'income' : 'expense'}`;
        item.innerHTML = `<div class="transaction-info"><h4>${escapeHtml(transaction.description)}</h4><p>${escapeHtml(transaction.category)} ${transaction.subcategory ? '- ' + escapeHtml(transaction.subcategory) : ''} | ${escapeHtml(transaction.account)}</p><small>${formatDate(transaction.date)}</small></div><div class="transaction-amount ${transaction.type === 'ingreso' ? 'amount-income' : 'amount-expense'}">${transaction.type === 'ingreso' ? '+' : '-'}${formatCurrency(Math.abs(amount))}</div>`;
        container.appendChild(item);
    });
}

function selectCategory(category) {
    document.querySelectorAll('.category-btn.selected').forEach(btn => btn.classList.remove('selected'));
    const selectedBtn = Array.from(document.querySelectorAll('.category-btn')).find(btn => btn.textContent === category);
    if (selectedBtn) selectedBtn.classList.add('selected');
    const subcategoryGroup = document.getElementById('subcategoryGroup');
    const subcategoryContainer = document.getElementById('subcategoryContainer');
    const subcats = categories[currentTransactionType][category];
    if (subcats && subcats.length > 0) {
        subcategoryGroup.style.display = 'block';
        subcategoryContainer.innerHTML = '';
        subcats.forEach(subcat => {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'subcategory-btn';
            button.textContent = subcat;
            button.addEventListener('click', () => {
                document.querySelectorAll('.subcategory-btn.selected').forEach(btn => btn.classList.remove('selected'));
                button.classList.add('selected');
                const isPayment = category === 'Créditos' && subcat === 'Pago Tarjeta';
                document.getElementById('standard-form-fields').style.display = isPayment ? 'none' : 'block';
                document.getElementById('transfer-form-fields').style.display = isPayment ? 'block' : 'none';
            });
            subcategoryContainer.appendChild(button);
        });
    } else {
        subcategoryGroup.style.display = 'none';
        subcategoryContainer.innerHTML = '';
        document.getElementById('standard-form-fields').style.display = 'block';
        document.getElementById('transfer-form-fields').style.display = 'none';
    }
}

// MEJORA: Lógica de envío secuencial y segura para los pagos de tarjeta.
async function addTransaction() {
    const date = document.getElementById('date').value;
    const amount = parseFloat(document.getElementById('amount').value);

    if (document.getElementById('transfer-form-fields').style.display === 'block') {
        const transferFrom = document.getElementById('transferFrom').value;
        const transferTo = document.getElementById('transferTo').value;
        if (!amount || amount <= 0 || !transferFrom || !transferTo || !date) {
            alert('Para un pago, selecciona las cuentas de origen y destino, y un monto válido.'); return;
        }
        
        isLoading = true;
        showLoadingState();

        const expenseTransaction = { type: 'gasto', amount: amount, description: `Pago a ${transferTo}`, category: 'Créditos', subcategory: 'Pago Tarjeta', account: transferFrom, date: date, EsTransferencia: 'sí' };
        await sendDataToSheet('addTransaction', expenseTransaction, false); // Envía sin recargar

        const incomeTransaction = { type: 'ingreso', amount: amount, description: `Abono desde ${transferFrom}`, category: 'Créditos', subcategory: 'Pago Tarjeta', account: transferTo, date: date, EsTransferencia: 'sí' };
        await sendDataToSheet('addTransaction', incomeTransaction, true); // Envía Y AHORA SÍ recarga
    } else {
        const description = document.getElementById('description').value;
        const account = document.getElementById('account').value;
        if (!amount || amount <= 0 || !description || !account || !date) { alert('Por favor, completa todos los campos.'); return; }
        const category = document.querySelector('.category-btn.selected')?.textContent || '';
        if (!category) { alert('Por favor selecciona una categoría'); return; }
        const subcategory = document.querySelector('.subcategory-btn.selected')?.textContent || '';
        const transaction = { type: currentTransactionType, amount, description, category, subcategory, account, date, EsTransferencia: '' };
        sendDataToSheet('addTransaction', transaction);
    }
    document.getElementById('transactionForm').reset();
    document.getElementById('date').valueAsDate = new Date();
    document.getElementById('subcategoryGroup').style.display = 'none';
    document.querySelectorAll('.selected').forEach(btn => btn.classList.remove('selected'));
    document.getElementById('standard-form-fields').style.display = 'block';
    document.getElementById('transfer-form-fields').style.display = 'none';
}

function addAccount() {
    const name = document.getElementById('newAccountName').value;
    const initialBalance = parseFloat(document.getElementById('initialBalance').value) || 0;
    if (!name) { alert('Por favor ingresa un nombre para la cuenta'); return; }
    const account = { name, initialBalance, date: new Date().toISOString().split('T')[0] };
    sendDataToSheet('addAccount', account);
    document.getElementById('accountForm').reset();
}

function addObligation() {
    const name = document.getElementById('obligationName').value;
    const type = document.getElementById('obligationType').value;
    const limit = parseFloat(document.getElementById('creditLimit').value);
    const paymentDay = parseInt(document.getElementById('paymentDay').value);
    if (!name || !limit || limit <= 0 || !paymentDay || paymentDay < 1 || paymentDay > 31) { alert('Por favor, completa todos los campos con valores válidos.'); return; }
    const obligation = { id: 'obl_' + Date.now(), name, type, limit, paymentDay };
    sendDataToSheet('addObligation', obligation);
    document.getElementById('obligationForm').reset();
}

function initializeApp() {
    console.log('Inicializando aplicación...');
    initializeCategories();
    setupTransactionTypeButtons();
    setupFormHandlers();
    document.getElementById('date').valueAsDate = new Date();
    loadFinancialData();
    console.log('Aplicación inicializada.');
}

// --- Resto de funciones auxiliares (sin cambios) ---

function updateBalanceCards(totals) { document.getElementById('totalIncome').textContent = formatCurrency(totals.monthlyIncome); document.getElementById('totalExpenses').textContent = formatCurrency(totals.monthlyExpenses); document.getElementById('currentBalance').textContent = formatCurrency(totals.totalBalance); document.getElementById('remainingBudget').textContent = formatCurrency(totals.remainingBudget); }
function initializeChart(transactions) {
    const ctx = document.getElementById('monthlyChart').getContext('2d');
    if (!ctx) return;
    if (monthlyChart) monthlyChart.destroy(); const months = []; const incomeData = []; const expensesData = []; const currentDate = new Date();
    for (let i = 5; i >= 0; i--) {
        const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
        months.push(date.toLocaleDateString('es-CO', { month: 'short', year: 'numeric' }));
        let monthlyIncome = 0, monthlyExpenses = 0;
        if (transactions && Array.isArray(transactions)) {
            transactions.forEach(t => {
                if (t.category === 'Créditos' && t.subcategory === 'Pago Tarjeta') return;
                const tDate = new Date(t.date);
                if (tDate.getMonth() === date.getMonth() && tDate.getFullYear() === date.getFullYear()) {
                    const amount = parseFloat(t.amount) || 0;
                    if (t.type === 'ingreso') monthlyIncome += amount;
                    else if (t.type === 'gasto') monthlyExpenses += amount;
                }
            });
        }
        incomeData.push(monthlyIncome); expensesData.push(monthlyExpenses);
    }
    monthlyChart = new Chart(ctx, { type: 'line', data: { labels: months, datasets: [ { label: 'Ingresos', data: incomeData, borderColor: '#4CAF50', backgroundColor: 'rgba(76, 175, 80, 0.1)', tension: 0.3, fill: true }, { label: 'Gastos', data: expensesData, borderColor: '#FF7043', backgroundColor: 'rgba(255, 112, 67, 0.1)', tension: 0.3, fill: true } ] }, options: { responsive: true, plugins: { title: { display: true, text: 'Comportamiento Financiero últimos 6 meses' } }, scales: { y: { beginAtZero: true, ticks: { callback: (value) => '$' + value.toLocaleString('es-CO') } } } } });
}
function updateAccountDropdowns(accounts, obligations) {
    const accountDropdown = document.getElementById('account'); const transferFrom = document.getElementById('transferFrom'); const transferTo = document.getElementById('transferTo');
    [accountDropdown, transferFrom, transferTo].forEach(dd => dd.innerHTML = '<option value="">Seleccionar...</option>');
    if (accounts) accounts.forEach(acc => { [accountDropdown, transferFrom].forEach(dd => dd.add(new Option(acc.name, acc.name))); });
    if (obligations) obligations.forEach(obl => { [accountDropdown, transferTo].forEach(dd => dd.add(new Option(obl.name, obl.name))); });
}
function formatCurrency(amount) { return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(parseFloat(amount) || 0); }
function formatDate(dateString) { try { const date = new Date(dateString); const userTimezoneOffset = date.getTimezoneOffset() * 60000; return new Date(date.getTime() + userTimezoneOffset).toLocaleDateString('es-CO', {day:'2-digit', month: '2-digit', year:'numeric'}); } catch { return dateString; } }
function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text || ''; return div.innerHTML; }
function showLoadingState() { document.getElementById('loadingOverlay').style.display = 'flex'; }
function hideLoadingState() { document.getElementById('loadingOverlay').style.display = 'none'; }
function showOfflineMode() { document.getElementById('offlineMode').style.display = 'block'; }
function hideOfflineMode() { document.getElementById('offlineMode').style.display = 'none'; }
function retryLoadData() { loadFinancialData(); }
function loadFallbackData() {
    const fallbackData = { accounts: [{name: "Bancolombia (Offline)", initialBalance: 5000000, date: "2025-09-15"}], obligations: [{id: "obl_1", name: "Visa (Offline)", type: "Tarjeta de Crédito", limit: 10000000, paymentDay: 15}], transactions: [{type: "ingreso", amount: 4000000, description: "Nómina (Offline)", category: "Salario", account: "Bancolombia (Offline)", date: "2025-09-15"}], status: "offline" };
    updateInterface(fallbackData); initializeChart(fallbackData.transactions);
}
function initializeCategories() {
    const container = document.getElementById('categoryContainer'); container.innerHTML = '';
    Object.keys(categories[currentTransactionType]).forEach(category => {
        const button = document.createElement('button'); button.type = 'button'; button.className = 'category-btn'; button.textContent = category;
        button.addEventListener('click', () => selectCategory(category)); container.appendChild(button);
    });
}
function setupTransactionTypeButtons() {
    document.querySelectorAll('.transaction-type-buttons .btn').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('.transaction-type-buttons .btn').forEach(btn => btn.classList.remove('active')); this.classList.add('active');
            currentTransactionType = this.dataset.type; initializeCategories(); document.getElementById('subcategoryGroup').style.display = 'none';
            document.getElementById('standard-form-fields').style.display = 'block'; document.getElementById('transfer-form-fields').style.display = 'none';
        });
    });
}
function setupFormHandlers() {
    document.getElementById('transactionForm').addEventListener('submit', e => { e.preventDefault(); addTransaction(); });
    document.getElementById('accountForm').addEventListener('submit', e => { e.preventDefault(); addAccount(); });
    document.getElementById('obligationForm').addEventListener('submit', e => { e.preventDefault(); addObligation(); });
}
function setMonthlyBudget() { const budget = prompt('Ingresa tu presupuesto mensual:'); if (budget !== null && !isNaN(parseFloat(budget))) alert(`Presupuesto mensual: ${formatCurrency(budget)}`); }
function generateReport() { alert('Función de generar reporte en desarrollo.'); }
function exportData() { alert('Función de exportar datos en desarrollo.'); }
function clearAllData() { if (confirm('¿Seguro que quieres eliminar todos los datos?')) alert('Función de limpiar datos en desarrollo.'); }
document.addEventListener('DOMContentLoaded', initializeApp);
</script>
</body>
</html>